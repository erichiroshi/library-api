name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Apenas TAG da imagem existente (n√£o rebuild!)
      - name: Tag and push versioned image
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/library-api:latest
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/library-api:latest \
                     ${{ secrets.DOCKERHUB_USERNAME }}/library-api:${{ steps.version.outputs.VERSION }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/library-api:${{ steps.version.outputs.VERSION }}

      # Gera release notes automaticamente
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## üê≥ Docker Image
            
            ```bash
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/library-api:${{ steps.version.outputs.VERSION }}
            ```
            
            ## üì¶ Installation
            
            ### Docker Compose
            ```yaml
            services:
              library-api:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/library-api:${{ steps.version.outputs.VERSION }}
                ports:
                  - "8080:8080"
                environment:
                  SPRING_PROFILES_ACTIVE: prod
            ```
            
            ### Docker Run
            ```bash
            docker run -d \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              ${{ secrets.DOCKERHUB_USERNAME }}/library-api:${{ steps.version.outputs.VERSION }}
            ```
